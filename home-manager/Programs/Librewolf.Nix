{ config, lib, ... }:

let
  cfg = config.programs.librewolf;

  mkOverridesFile = prefs: ''
    // Generated by Home Manager.
    ${lib.concatStrings (
      lib.mapAttrsToList (name: value: ''
        defaultPref("${name}", ${builtins.toJSON value});
      '') prefs
    )}
  '';

  modulePath = [
    "programs"
    "librewolf"
  ];

  mkFirefoxModule = import ./firefox/mkFirefoxModule.nix;

in
{
  meta.maintainers = with lib.maintainers; [
    chayleaf
    onny
  ];

  imports = [
    (mkFirefoxModule {
      inherit modulePath;
      name = "LibreWolf";
      description = "LibreWolf is a privacy enhanced Firefox fork.";
      wrappedPackageName = "librewolf";
      unwrappedPackageName = "librewolf-unwrapped";
      visible = true;

      platforms.linux = {
        configPath = ".librewolf";
      };
      platforms.darwin = {
        configPath = "Library/Application Support/LibreWolf";
      };
    })
  ];

  options.programs.librewolf = {
    settings = lib.mkOption {
      type = with lib.types; attrsOf (either bool (either int str));
      default = { };
      example = lib.literalExpression ''
        {
          "webgl.disabled" = false;
          "privacy.resistFingerprinting" = false;
        }
      '';
      description = ''
        Attribute set of global LibreWolf settings and overrides. Refer to
        <https://librewolf.net/docs/settings/>
        for details on supported values.
      '';
    };
  };

  config = lib.mkIf cfg.enable {
    home.file.".librewolf/librewolf.overrides.cfg" = lib.mkIf (cfg.settings != { }) {
      text = mkOverridesFile cfg.settings;
    };

    mozilla.librewolfNativeMessagingHosts =
      cfg.nativeMessagingHosts
      ++ (lib.optional (cfg.finalPackage != null) cfg.finalPackage);

    # Custom CSS theme
    home.file.".librewolf/userChrome.css" = {
      text = ''
        /* Add your custom CSS theme here */
        * {
          background-color: #1e1e1e !important;
          color: #dcdcdc !important;
        }
      '';
    };

    # Vim Plugins
    home.file.".librewolf/vimrc" = {
      text = ''
        set number
        set relativenumber
        set expandtab
        set tabstop=4
        set shiftwidth=4
        " Add more vim configuration here as needed
      '';
    };

    # Recommended browser extensions
    config.programs.librewolf = {
      extensions = [
        "uBlock Origin"
        "Filter Stalker"
        "fuckfuckadblock"
        "iplogger"
        "Anifiltrs"
        "Web Annoyances Ultralist"
        "FastForward"
        "ClearURLs"
        "NoScript"
        "LocalCDN"
        "ToS;DR"
        "JustDeleteMe"
        "The Great Suspender"
        "Search by Image"
        "Download All Images"
        "Buster"
        "Web Archives"
        "SingleFile"
        "SingleFileZ"
        "UserAgent-Switcher"
        "Temporary Containers"
        "Cookie AutoDelete"
        "Allow Right Click"
        "DownThemAll!"
        "Media Reaper"
        "ViolentMonkey"
        "Stylus"
        "SponsorBlock"
        "Return YouTube Dislike"
      ];

      # Browser UserScripts
      userScripts = [
        "AdGuard Popup Blocker"
        "AdsBypasser"
        "Bypass All Shortlinks"
        "SiteScrubber"
        "Direct links out"
        "MoreCAPTCHA"
        "Mega.nz Unlimited Import"
        "YouTube Age Bypass"
        "Google Unlocked"
        "Direct Download from Google Play"
      ];
    };
  };
}
